name: CI

on:
  push:
    branches: [ main, master, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - 'docs/**'

jobs:
  pssa-lint:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v6

    - name: Install PSScriptAnalyzer
      shell: pwsh
      run: |
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser
        Import-Module PSScriptAnalyzer

    - name: Run PSScriptAnalyzer
      shell: pwsh
      run: |
        $results = Invoke-ScriptAnalyzer -Path ./src -Recurse -Severity Warning,Error
        $results | Format-Table -AutoSize
        if ($results.Severity -contains "Error") {
          Write-Error "PSScriptAnalyzer found errors"
          exit 1
        }

  powershell-syntax:
    runs-on: windows-latest
    strategy:
      matrix:
        ps-version: ['5.1', '7.4']
    steps:
    - uses: actions/checkout@v6

    - name: Setup PowerShell ${{ matrix.ps-version }}
      uses: actions/setup-powershell@v1
      with:
        powershell-version: ${{ matrix.ps-version }}
      continue-on-error: true

    - name: Check PowerShell syntax
      shell: pwsh
      run: |
        $scripts = Get-ChildItem -Path ./src -Filter "*.ps1" -Recurse
        foreach ($script in $scripts) {
          $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content -Path $script.FullName -Raw), [ref]$null)
          Write-Host "✓ Syntax valid: $($script.Name)"
        }

  security-scan:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v6

    - name: Security scan for secrets
      shell: pwsh
      run: |
        $patterns = @(
          'password\s*=\s*["\'][^"\']+["\']',
          'apikey\s*=\s*["\'][^"\']+["\']',
          'secret\s*=\s*["\'][^"\']+["\']',
          'token\s*=\s*["\'][^"\']+["\']'
        )
        $scripts = Get-ChildItem -Path ./src -Filter "*.ps1" -Recurse
        $found = $false
        foreach ($script in $scripts) {
          $content = Get-Content -Path $script.FullName -Raw
          foreach ($pattern in $patterns) {
            if ($content -match $pattern) {
              Write-Warning "Potential secret found in $($script.Name)"
              $found = $true
            }
          }
        }
        if (-not $found) {
          Write-Host "✓ No obvious secrets found"
        }

  documentation-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6

    - name: Check README exists
      run: |
        test -f README.md || (echo "README.md is missing" && exit 1)
        echo "✓ README.md exists"

    - name: Check for documentation
      run: |
        grep -q "OCR\|Tesseract" README.md && echo "✓ OCR mentioned in README"
